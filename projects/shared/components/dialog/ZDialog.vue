<script lang="ts" setup>
import { ref } from 'vue'
import { useVModel } from '@vueuse/core'
import { QScrollArea } from 'quasar'
import type { QDialogProps } from 'quasar'
import ZBtn from '../btn/ZBtn.vue'
import ZLoading from '../loading/ZLoading.vue'
import { useSysConfig } from '../../composables/app'

interface ZDialogProps {
  modelValue?: boolean
  title: string
  caption?: string
  footer?: boolean
  disableConfirm?: boolean
  cancelText?: string
  confirmText?: string
  wrapperStyle?: Record<string, any>
  /** 是否使用滚动区域 */
  scroll?: boolean
  loading?: boolean
  params?: Omit<QDialogProps, 'modelValue'>
}

const props = withDefaults(defineProps<ZDialogProps>(), {
  cancelText: '取消',
  confirmText: '确认',
})
defineEmits(['update:modelValue', 'ok'])

const scrollRef = ref<InstanceType<typeof QScrollArea>>()

const { isAdmin } = useSysConfig()

const value = useVModel(props, 'modelValue')

defineExpose({
  scrollRef,
})
</script>

<template>
  <q-dialog
    persistent
    v-model="value"
    v-bind="params"
  >
    <q-card
      :rounded="isAdmin ? '3!' : '0!'" flex="~ col gap6" py6
      :style="{
        minWidth: '460px',
        height: scroll ? 'calc(100vh - 100px)' : 'auto',
        ...wrapperStyle,
      }"
    >
      <header flex="~ row justify-between items-center" px6>
        <div flex="~ row items-center gap1">
          <div font-600 v-text="title" />
          <div text="sm grey-6" font-400 v-text="caption" />
        </div>

        <q-btn v-close-popup dense flat p0 h6 w6 min-h="auto!">
          <div i-mingcute:close-line text-grey-5 text-lg />
        </q-btn>
      </header>

      <div v-if="scroll" flex="~ col 1" h0 b-y-1>
        <q-scroll-area ref="scrollRef" class="z-dialog__scrollarea" full px6>
          <div py6>
            <slot />
          </div>
        </q-scroll-area>
      </div>

      <div v-else px6 pb4>
        <slot />
      </div>

      <footer v-if="footer" flex="~ row justify-end gap6" px6>
        <ZBtn
          v-close-popup
          min-w-28
          :label="cancelText"
          text-color="primary-1"
          :params="{
            outline: true,
          }"
        />
        <ZBtn
          v-close-popup
          min-w-28
          :label="confirmText"
          :disable="disableConfirm"
          @click="$emit('ok')"
        />
      </footer>

      <ZLoading :value="loading" />
    </q-card>
  </q-dialog>
</template>

<style lang="scss" scoped>
.q-card {
  &::-webkit-scrollbar {
    display: none;
  }
}
</style>
